name: "Create Release Branch"

on:
  release:
    types: [released]

# Default empty permissions for all jobs
permissions: {}

jobs:
  create-release-branch:
    if: ${{ endsWith(github.event.release.tag_name, '.0') }}
    permissions:
      id-token: write
    uses: ./.github/workflows/reusable_create-release-branch.yaml
    secrets:
      APP_ID: ${{ secrets.APP_ID }}
      AUTOMATION_KEY: ${{ secrets.AUTOMATION_KEY }}
  
  create-backport-label:
    needs: create-release-branch
    permissions:
      issues: write
    runs-on: ubuntu-latest
    steps:
      - name: Create Backport PR label if it doesn't exist
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagName = context.payload.release?.tag_name;
            if (!tagName) {
              console.error("‚ùå No tag name found in the release payload");
              throw new Error("No tag name found");
            }
            // check if it matches vX.Y.Z format or something/vX.Y.Z
            const tagPattern = /^([\w/-_]+\/)?v\d+\.\d+\.\d+$/;
            if (!tagPattern.test(tagName)) {
              console.error(`‚ùå Tag name "${tagName}" does not match expected format`);
              throw new Error("Invalid tag name format");
            }
            const labelPrefix = "backport release/";
            // Extract the label name by removing patch version
            let labelName;
            if (tagName && tagName.includes('.')) {
              const lastDotIndex = tagName.lastIndexOf('.');
              labelName = `${labelPrefix}${tagName.substring(0, lastDotIndex)}`;
            } else {
              labelName = `${labelPrefix}${tagName}`;
            }

            const labelColor = "731ddb"; // purple
            const labelDescription = "Backport PR to release " + tagName;

            try {
              // Check if label already exists
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName,
              });
              console.log(`‚úÖ Label "${labelName}" already exists`);
            } catch (error) {
              if (error.status === 404) {
                console.log(`üè∑Ô∏è Creating label "${labelName}"`);
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelName,
                    color: labelColor,
                    description: labelDescription,
                  });
                  console.log(`‚úÖ Label "${labelName}" created`);
                } catch (createError) {
                  console.error(`‚ùå Error creating label "${labelName}":`, createError);
                  throw createError;
                }
              } else {
                console.error(`‚ùå Error getting label "${labelName}":`, error);
                throw error;
              }
            }

