name: ðŸ‘‹ Friendly Reminders

on:
  pull_request:
    branches: main

permissions:
  pull-requests: write

jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # 4.4.2
        with:
          persist-credentials: false
      - uses: actions/setup-go@0aaccfd150d50ccaeb58ebd88d36e91967a5f35b #v5.4.0
        with:
          go-version-file: "service/go.mod"

      - name: Check Go Mod Tidy
        id: go-mod-tidy
        run: |
          # iterate over work file, cd and run go mod tidy, capturing output
          : > go-mod-tidy-output.txt
          while IFS="" read -r line || [ -n "$line" ]; do
            (cd "$line" && go mod tidy >>../go-mod-tidy-output.txt 2>&1)
          done < <(go work edit --json | jq -r '.Use.[].DiskPath')
          # check if any changes were made
          git status --porcelain >>"$GITHUB_OUTPUT"

      - name: Prepare PR comment artifact
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          {
            echo "$PR_NUMBER"
            echo "Friendly Reminders: \`go mod tidy\` Output"
            echo '```'
            cat go-mod-tidy-output.txt
            echo '```'
          } > pr-comment.txt

      - name: Upload go mod tidy PR comment artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.workflow }}.${{ github.job }}.${{ github.event.pull_request.number }}
          path: pr-comment.txt
