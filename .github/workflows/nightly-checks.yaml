name: 'Nightly Checks'

on:
  schedule:
    - cron: '15 0 * * *'
  pull_request:

jobs:
  otdfctl:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
    steps:
      ######## CHECKOUT/SETUP PLATFORM #############
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          fetch-depth: 0
      - uses: actions/setup-go@cdcb36043654635271a94b9a6d1392de5bb323a7
        with:
          go-version-file: 'service/go.mod'
          check-latest: false
          cache-dependency-path: |
            examples/go.sum
            protocol/go/go.sum
            sdk/go.sum
            service/go.sum

      ######## SPIN UP PLATFORM/BACKEND #############
      - run: |
          ./.github/scripts/init-temp-keys.sh
          cp opentdf-dev.yaml opentdf.yaml
        working-directory: .
      - name: Added Trusted Certs
        run: |
          sudo chmod -R 777 ./keys
          sudo apt-get install -y ca-certificates
          sudo cp ./keys/localhost.crt /usr/local/share/ca-certificates
          sudo update-ca-certificates
        working-directory: .
      - run: docker compose up -d --wait --wait-timeout 240
        working-directory: .
      - run: go run ./service provision keycloak
        working-directory: .
      - run: go run ./service provision fixtures
        working-directory: .
      - uses: JarvusInnovations/background-action@2428e7b970a846423095c79d43f759abf979a635
        name: start server in background
        with:
          run: >
            go build -o opentdf -v service/main.go
            && .github/scripts/watch.sh opentdf.yaml ./opentdf start
          wait-on: |
            tcp:localhost:8080
          log-output-if: true
          wait-for: 90s
          working-directory: .

      ######## CHECKOUT/BUILD 'otdfctl' #############
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          repository: opentdf/otdfctl
          ref: main
          fetch-depth: 0
      - run: go build -o otdfctl

      ######## RUN TESTS #############
      - run: ./.github/scripts/connectivity-test.sh
        name: Flaky Connectivity Test
        working-directory: .
