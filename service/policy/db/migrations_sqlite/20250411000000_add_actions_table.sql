-- +goose Up
-- +goose StatementBegin

-- 1. Create new 'actions' table
CREATE TABLE IF NOT EXISTS actions (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    is_standard INTEGER NOT NULL DEFAULT 0,
    metadata TEXT,
    created_at TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%SZ', 'now')),
    updated_at TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%SZ', 'now'))
);

-- Updated_at trigger
CREATE TRIGGER IF NOT EXISTS actions_updated_at
AFTER UPDATE ON actions
BEGIN
    UPDATE actions SET updated_at = strftime('%Y-%m-%dT%H:%M:%SZ', 'now')
    WHERE id = NEW.id;
END;

-- 1a. Create intermediary table to hold the mapping of actions to subject_mappings
CREATE TABLE IF NOT EXISTS subject_mapping_actions (
    subject_mapping_id TEXT NOT NULL REFERENCES subject_mappings(id) ON DELETE CASCADE,
    action_id TEXT NOT NULL REFERENCES actions(id) ON DELETE CASCADE,
    created_at TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%SZ', 'now')),
    PRIMARY KEY (subject_mapping_id, action_id)
);

CREATE INDEX IF NOT EXISTS idx_subject_mapping_actions_subject ON subject_mapping_actions(subject_mapping_id);
CREATE INDEX IF NOT EXISTS idx_subject_mapping_actions_action ON subject_mapping_actions(action_id);

-- 2. Insert standard CRUD actions
-- Note: IDs will be generated by the application layer during first run
-- For initial migration, we use predefined UUIDs for standard actions
INSERT OR IGNORE INTO actions (id, name, is_standard) VALUES
    ('a0000000-0000-0000-0000-000000000001', 'create', 1),
    ('a0000000-0000-0000-0000-000000000002', 'read', 1),
    ('a0000000-0000-0000-0000-000000000003', 'update', 1),
    ('a0000000-0000-0000-0000-000000000004', 'delete', 1);

-- 3. Note: Migration of existing subject_mapping.actions column handled in app layer
-- SQLite cannot use LATERAL joins for the complex migration. The app layer will:
-- 1. Parse the old JSONB actions array if it exists
-- 2. Create corresponding entries in subject_mapping_actions
-- 3. Drop the old column programmatically

-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin

-- Drop the intermediary table
DROP TABLE IF EXISTS subject_mapping_actions;

-- Drop the actions table
DROP TABLE IF EXISTS actions;

-- +goose StatementEnd
