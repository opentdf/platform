// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: namespaces.sql

package sqlite

import (
	"context"
	"database/sql"
)

const assignCertificateToNamespace = `-- name: assignCertificateToNamespace :one
INSERT INTO attribute_namespace_certificates (namespace_id, certificate_id)
VALUES (?1, ?2)
RETURNING namespace_id, certificate_id
`

type assignCertificateToNamespaceParams struct {
	NamespaceID   string `json:"namespace_id"`
	CertificateID string `json:"certificate_id"`
}

// assignCertificateToNamespace
//
//	INSERT INTO attribute_namespace_certificates (namespace_id, certificate_id)
//	VALUES (?1, ?2)
//	RETURNING namespace_id, certificate_id
func (q *Queries) assignCertificateToNamespace(ctx context.Context, arg assignCertificateToNamespaceParams) (AttributeNamespaceCertificate, error) {
	row := q.db.QueryRowContext(ctx, assignCertificateToNamespace, arg.NamespaceID, arg.CertificateID)
	var i AttributeNamespaceCertificate
	err := row.Scan(&i.NamespaceID, &i.CertificateID)
	return i, err
}

const assignPublicKeyToNamespace = `-- name: assignPublicKeyToNamespace :one
INSERT INTO attribute_namespace_public_key_map (namespace_id, key_access_server_key_id)
VALUES (?1, ?2)
RETURNING namespace_id, key_access_server_key_id
`

type assignPublicKeyToNamespaceParams struct {
	NamespaceID          string `json:"namespace_id"`
	KeyAccessServerKeyID string `json:"key_access_server_key_id"`
}

// assignPublicKeyToNamespace
//
//	INSERT INTO attribute_namespace_public_key_map (namespace_id, key_access_server_key_id)
//	VALUES (?1, ?2)
//	RETURNING namespace_id, key_access_server_key_id
func (q *Queries) assignPublicKeyToNamespace(ctx context.Context, arg assignPublicKeyToNamespaceParams) (AttributeNamespacePublicKeyMap, error) {
	row := q.db.QueryRowContext(ctx, assignPublicKeyToNamespace, arg.NamespaceID, arg.KeyAccessServerKeyID)
	var i AttributeNamespacePublicKeyMap
	err := row.Scan(&i.NamespaceID, &i.KeyAccessServerKeyID)
	return i, err
}

const countCertificateNamespaceAssignments = `-- name: countCertificateNamespaceAssignments :one
SELECT COUNT(*) FROM attribute_namespace_certificates
WHERE certificate_id = ?1
`

// countCertificateNamespaceAssignments
//
//	SELECT COUNT(*) FROM attribute_namespace_certificates
//	WHERE certificate_id = ?1
func (q *Queries) countCertificateNamespaceAssignments(ctx context.Context, certificateID string) (int64, error) {
	row := q.db.QueryRowContext(ctx, countCertificateNamespaceAssignments, certificateID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createCertificate = `-- name: createCertificate :one

INSERT INTO certificates (id, pem, metadata)
VALUES (?1, ?2, ?3)
RETURNING id
`

type createCertificateParams struct {
	ID       string         `json:"id"`
	Pem      string         `json:"pem"`
	Metadata sql.NullString `json:"metadata"`
}

// --------------------------------------------------------------
// CERTIFICATES (SQLite)
// --------------------------------------------------------------
// Note: ID generated in application layer before INSERT
//
//	INSERT INTO certificates (id, pem, metadata)
//	VALUES (?1, ?2, ?3)
//	RETURNING id
func (q *Queries) createCertificate(ctx context.Context, arg createCertificateParams) (string, error) {
	row := q.db.QueryRowContext(ctx, createCertificate, arg.ID, arg.Pem, arg.Metadata)
	var id string
	err := row.Scan(&id)
	return id, err
}

const createNamespace = `-- name: createNamespace :one
INSERT INTO attribute_namespaces (id, name, metadata)
VALUES (?1, ?2, ?3)
RETURNING id
`

type createNamespaceParams struct {
	ID       string         `json:"id"`
	Name     string         `json:"name"`
	Metadata sql.NullString `json:"metadata"`
}

// Note: ID generated in application layer before INSERT
//
//	INSERT INTO attribute_namespaces (id, name, metadata)
//	VALUES (?1, ?2, ?3)
//	RETURNING id
func (q *Queries) createNamespace(ctx context.Context, arg createNamespaceParams) (string, error) {
	row := q.db.QueryRowContext(ctx, createNamespace, arg.ID, arg.Name, arg.Metadata)
	var id string
	err := row.Scan(&id)
	return id, err
}

const deleteCertificate = `-- name: deleteCertificate :execrows
DELETE FROM certificates WHERE id = ?1
`

// deleteCertificate
//
//	DELETE FROM certificates WHERE id = ?1
func (q *Queries) deleteCertificate(ctx context.Context, id string) (int64, error) {
	result, err := q.db.ExecContext(ctx, deleteCertificate, id)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const deleteNamespace = `-- name: deleteNamespace :execrows
DELETE FROM attribute_namespaces WHERE id = ?1
`

// deleteNamespace
//
//	DELETE FROM attribute_namespaces WHERE id = ?1
func (q *Queries) deleteNamespace(ctx context.Context, id string) (int64, error) {
	result, err := q.db.ExecContext(ctx, deleteNamespace, id)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const getCertificate = `-- name: getCertificate :one
SELECT
    id,
    pem,
    json_object(
        'labels', json_extract(metadata, '$.labels'),
        'created_at', created_at,
        'updated_at', updated_at
    ) as metadata
FROM certificates
WHERE id = ?1
`

type getCertificateRow struct {
	ID       string      `json:"id"`
	Pem      string      `json:"pem"`
	Metadata interface{} `json:"metadata"`
}

// getCertificate
//
//	SELECT
//	    id,
//	    pem,
//	    json_object(
//	        'labels', json_extract(metadata, '$.labels'),
//	        'created_at', created_at,
//	        'updated_at', updated_at
//	    ) as metadata
//	FROM certificates
//	WHERE id = ?1
func (q *Queries) getCertificate(ctx context.Context, id string) (getCertificateRow, error) {
	row := q.db.QueryRowContext(ctx, getCertificate, id)
	var i getCertificateRow
	err := row.Scan(&i.ID, &i.Pem, &i.Metadata)
	return i, err
}

const getCertificateByPEM = `-- name: getCertificateByPEM :one
SELECT
    id,
    pem,
    json_object(
        'labels', json_extract(metadata, '$.labels'),
        'created_at', created_at,
        'updated_at', updated_at
    ) as metadata
FROM certificates
WHERE pem = ?1
`

type getCertificateByPEMRow struct {
	ID       string      `json:"id"`
	Pem      string      `json:"pem"`
	Metadata interface{} `json:"metadata"`
}

// getCertificateByPEM
//
//	SELECT
//	    id,
//	    pem,
//	    json_object(
//	        'labels', json_extract(metadata, '$.labels'),
//	        'created_at', created_at,
//	        'updated_at', updated_at
//	    ) as metadata
//	FROM certificates
//	WHERE pem = ?1
func (q *Queries) getCertificateByPEM(ctx context.Context, pem string) (getCertificateByPEMRow, error) {
	row := q.db.QueryRowContext(ctx, getCertificateByPEM, pem)
	var i getCertificateByPEMRow
	err := row.Scan(&i.ID, &i.Pem, &i.Metadata)
	return i, err
}

const getNamespace = `-- name: getNamespace :one
SELECT
    ns.id,
    ns.name,
    ns.active,
    fqns.fqn,
    json_object(
        'labels', json_extract(ns.metadata, '$.labels'),
        'created_at', ns.created_at,
        'updated_at', ns.updated_at
    ) as metadata,
    -- Grants aggregation using json_group_array
    (
        SELECT json_group_array(
            json_object(
                'id', kas.id,
                'uri', kas.uri,
                'name', kas.name,
                'public_key', kas.public_key
            )
        )
        FROM attribute_namespace_key_access_grants kas_ns_grants
        JOIN key_access_servers kas ON kas.id = kas_ns_grants.key_access_server_id
        WHERE kas_ns_grants.namespace_id = ns.id
    ) as grants,
    -- Keys: simplified, full key details fetched separately
    (
        SELECT json_group_array(
            json_object(
                'kas_id', kas.id,
                'kas_uri', kas.uri,
                'key_id', kask.key_id,
                'algorithm', kask.key_algorithm
            )
        )
        FROM attribute_namespace_public_key_map k
        INNER JOIN key_access_server_keys kask ON k.key_access_server_key_id = kask.id
        INNER JOIN key_access_servers kas ON kask.key_access_server_id = kas.id
        WHERE k.namespace_id = ns.id
    ) as keys,
    -- Certs aggregation
    (
        SELECT json_group_array(
            json_object(
                'id', cert.id,
                'pem', cert.pem
            )
        )
        FROM attribute_namespace_certificates c
        INNER JOIN certificates cert ON c.certificate_id = cert.id
        WHERE c.namespace_id = ns.id
    ) as certs
FROM attribute_namespaces ns
LEFT JOIN attribute_fqns fqns ON fqns.namespace_id = ns.id
WHERE fqns.attribute_id IS NULL AND fqns.value_id IS NULL
  AND (?1 IS NULL OR ns.id = ?1)
  AND (?2 IS NULL OR ns.name = REPLACE(REPLACE(?2, 'https://', ''), 'http://', ''))
`

type getNamespaceParams struct {
	ID   interface{} `json:"id"`
	Name interface{} `json:"name"`
}

type getNamespaceRow struct {
	ID       string         `json:"id"`
	Name     string         `json:"name"`
	Active   int64          `json:"active"`
	Fqn      sql.NullString `json:"fqn"`
	Metadata interface{}    `json:"metadata"`
	Grants   interface{}    `json:"grants"`
	Keys     interface{}    `json:"keys"`
	Certs    interface{}    `json:"certs"`
}

// Note: SQLite version simplified - complex JSONB aggregations handled in app layer
// Keys and certs returned as separate queries or handled by PolicyDBClient
//
//	SELECT
//	    ns.id,
//	    ns.name,
//	    ns.active,
//	    fqns.fqn,
//	    json_object(
//	        'labels', json_extract(ns.metadata, '$.labels'),
//	        'created_at', ns.created_at,
//	        'updated_at', ns.updated_at
//	    ) as metadata,
//	    -- Grants aggregation using json_group_array
//	    (
//	        SELECT json_group_array(
//	            json_object(
//	                'id', kas.id,
//	                'uri', kas.uri,
//	                'name', kas.name,
//	                'public_key', kas.public_key
//	            )
//	        )
//	        FROM attribute_namespace_key_access_grants kas_ns_grants
//	        JOIN key_access_servers kas ON kas.id = kas_ns_grants.key_access_server_id
//	        WHERE kas_ns_grants.namespace_id = ns.id
//	    ) as grants,
//	    -- Keys: simplified, full key details fetched separately
//	    (
//	        SELECT json_group_array(
//	            json_object(
//	                'kas_id', kas.id,
//	                'kas_uri', kas.uri,
//	                'key_id', kask.key_id,
//	                'algorithm', kask.key_algorithm
//	            )
//	        )
//	        FROM attribute_namespace_public_key_map k
//	        INNER JOIN key_access_server_keys kask ON k.key_access_server_key_id = kask.id
//	        INNER JOIN key_access_servers kas ON kask.key_access_server_id = kas.id
//	        WHERE k.namespace_id = ns.id
//	    ) as keys,
//	    -- Certs aggregation
//	    (
//	        SELECT json_group_array(
//	            json_object(
//	                'id', cert.id,
//	                'pem', cert.pem
//	            )
//	        )
//	        FROM attribute_namespace_certificates c
//	        INNER JOIN certificates cert ON c.certificate_id = cert.id
//	        WHERE c.namespace_id = ns.id
//	    ) as certs
//	FROM attribute_namespaces ns
//	LEFT JOIN attribute_fqns fqns ON fqns.namespace_id = ns.id
//	WHERE fqns.attribute_id IS NULL AND fqns.value_id IS NULL
//	  AND (?1 IS NULL OR ns.id = ?1)
//	  AND (?2 IS NULL OR ns.name = REPLACE(REPLACE(?2, 'https://', ''), 'http://', ''))
func (q *Queries) getNamespace(ctx context.Context, arg getNamespaceParams) (getNamespaceRow, error) {
	row := q.db.QueryRowContext(ctx, getNamespace, arg.ID, arg.Name)
	var i getNamespaceRow
	err := row.Scan(
		&i.ID,
		&i.Name,
		&i.Active,
		&i.Fqn,
		&i.Metadata,
		&i.Grants,
		&i.Keys,
		&i.Certs,
	)
	return i, err
}

const listNamespaces = `-- name: listNamespaces :many

SELECT
    COUNT(*) OVER() AS total,
    ns.id,
    ns.name,
    ns.active,
    json_object(
        'labels', json_extract(ns.metadata, '$.labels'),
        'created_at', ns.created_at,
        'updated_at', ns.updated_at
    ) as metadata,
    fqns.fqn
FROM attribute_namespaces ns
LEFT JOIN attribute_fqns fqns ON ns.id = fqns.namespace_id AND fqns.attribute_id IS NULL
WHERE (?1 IS NULL OR ns.active = ?1)
LIMIT ?3
OFFSET ?2
`

type listNamespacesParams struct {
	Active interface{} `json:"active"`
	Offset int64       `json:"offset_"`
	Limit  int64       `json:"limit_"`
}

type listNamespacesRow struct {
	Total    int64          `json:"total"`
	ID       string         `json:"id"`
	Name     string         `json:"name"`
	Active   int64          `json:"active"`
	Metadata interface{}    `json:"metadata"`
	Fqn      sql.NullString `json:"fqn"`
}

// --------------------------------------------------------------
// NAMESPACES (SQLite)
// --------------------------------------------------------------
//
//	SELECT
//	    COUNT(*) OVER() AS total,
//	    ns.id,
//	    ns.name,
//	    ns.active,
//	    json_object(
//	        'labels', json_extract(ns.metadata, '$.labels'),
//	        'created_at', ns.created_at,
//	        'updated_at', ns.updated_at
//	    ) as metadata,
//	    fqns.fqn
//	FROM attribute_namespaces ns
//	LEFT JOIN attribute_fqns fqns ON ns.id = fqns.namespace_id AND fqns.attribute_id IS NULL
//	WHERE (?1 IS NULL OR ns.active = ?1)
//	LIMIT ?3
//	OFFSET ?2
func (q *Queries) listNamespaces(ctx context.Context, arg listNamespacesParams) ([]listNamespacesRow, error) {
	rows, err := q.db.QueryContext(ctx, listNamespaces, arg.Active, arg.Offset, arg.Limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []listNamespacesRow
	for rows.Next() {
		var i listNamespacesRow
		if err := rows.Scan(
			&i.Total,
			&i.ID,
			&i.Name,
			&i.Active,
			&i.Metadata,
			&i.Fqn,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const removeCertificateFromNamespace = `-- name: removeCertificateFromNamespace :execrows
DELETE FROM attribute_namespace_certificates
WHERE namespace_id = ?1 AND certificate_id = ?2
`

type removeCertificateFromNamespaceParams struct {
	NamespaceID   string `json:"namespace_id"`
	CertificateID string `json:"certificate_id"`
}

// removeCertificateFromNamespace
//
//	DELETE FROM attribute_namespace_certificates
//	WHERE namespace_id = ?1 AND certificate_id = ?2
func (q *Queries) removeCertificateFromNamespace(ctx context.Context, arg removeCertificateFromNamespaceParams) (int64, error) {
	result, err := q.db.ExecContext(ctx, removeCertificateFromNamespace, arg.NamespaceID, arg.CertificateID)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const removeKeyAccessServerFromNamespace = `-- name: removeKeyAccessServerFromNamespace :execrows
DELETE FROM attribute_namespace_key_access_grants
WHERE namespace_id = ?1 AND key_access_server_id = ?2
`

type removeKeyAccessServerFromNamespaceParams struct {
	NamespaceID       string `json:"namespace_id"`
	KeyAccessServerID string `json:"key_access_server_id"`
}

// removeKeyAccessServerFromNamespace
//
//	DELETE FROM attribute_namespace_key_access_grants
//	WHERE namespace_id = ?1 AND key_access_server_id = ?2
func (q *Queries) removeKeyAccessServerFromNamespace(ctx context.Context, arg removeKeyAccessServerFromNamespaceParams) (int64, error) {
	result, err := q.db.ExecContext(ctx, removeKeyAccessServerFromNamespace, arg.NamespaceID, arg.KeyAccessServerID)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const removePublicKeyFromNamespace = `-- name: removePublicKeyFromNamespace :execrows
DELETE FROM attribute_namespace_public_key_map
WHERE namespace_id = ?1 AND key_access_server_key_id = ?2
`

type removePublicKeyFromNamespaceParams struct {
	NamespaceID          string `json:"namespace_id"`
	KeyAccessServerKeyID string `json:"key_access_server_key_id"`
}

// removePublicKeyFromNamespace
//
//	DELETE FROM attribute_namespace_public_key_map
//	WHERE namespace_id = ?1 AND key_access_server_key_id = ?2
func (q *Queries) removePublicKeyFromNamespace(ctx context.Context, arg removePublicKeyFromNamespaceParams) (int64, error) {
	result, err := q.db.ExecContext(ctx, removePublicKeyFromNamespace, arg.NamespaceID, arg.KeyAccessServerKeyID)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const rotatePublicKeyForNamespace = `-- name: rotatePublicKeyForNamespace :many
UPDATE attribute_namespace_public_key_map
SET key_access_server_key_id = ?1
WHERE (key_access_server_key_id = ?2)
RETURNING namespace_id
`

type rotatePublicKeyForNamespaceParams struct {
	NewKeyID string `json:"new_key_id"`
	OldKeyID string `json:"old_key_id"`
}

// rotatePublicKeyForNamespace
//
//	UPDATE attribute_namespace_public_key_map
//	SET key_access_server_key_id = ?1
//	WHERE (key_access_server_key_id = ?2)
//	RETURNING namespace_id
func (q *Queries) rotatePublicKeyForNamespace(ctx context.Context, arg rotatePublicKeyForNamespaceParams) ([]string, error) {
	rows, err := q.db.QueryContext(ctx, rotatePublicKeyForNamespace, arg.NewKeyID, arg.OldKeyID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []string
	for rows.Next() {
		var namespace_id string
		if err := rows.Scan(&namespace_id); err != nil {
			return nil, err
		}
		items = append(items, namespace_id)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateNamespace = `-- name: updateNamespace :execrows
UPDATE attribute_namespaces
SET
    name = COALESCE(?1, name),
    active = COALESCE(?2, active),
    metadata = COALESCE(?3, metadata)
WHERE id = ?4
`

type updateNamespaceParams struct {
	Name     sql.NullString `json:"name"`
	Active   sql.NullInt64  `json:"active"`
	Metadata sql.NullString `json:"metadata"`
	ID       string         `json:"id"`
}

// updateNamespace: both Safe and Unsafe Updates
//
//	UPDATE attribute_namespaces
//	SET
//	    name = COALESCE(?1, name),
//	    active = COALESCE(?2, active),
//	    metadata = COALESCE(?3, metadata)
//	WHERE id = ?4
func (q *Queries) updateNamespace(ctx context.Context, arg updateNamespaceParams) (int64, error) {
	result, err := q.db.ExecContext(ctx, updateNamespace,
		arg.Name,
		arg.Active,
		arg.Metadata,
		arg.ID,
	)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}
