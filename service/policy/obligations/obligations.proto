syntax = "proto3";

package policy.obligations;
import "common/common.proto";
import "policy/objects.proto";
import "policy/selectors.proto";
import "buf/validate/validate.proto";
// import "google/protobuf/struct.proto";

///
/// Obligation
///

// Definitions
message GetObligationRequest {
    option (buf.validate.message).oneof = { fields: ["id", "fqn"], required: true };
    string id = 1 [(buf.validate.field).string.uuid = true];
    string fqn = 2 [
        (buf.validate.field).string = {
            min_len : 1
            uri : true
        }
    ];
}

message ValueTriggerRequest {
    option (buf.validate.message).cel = {
        id: "context_client_id_required"
        message: "RequestContext must have a clientID specified when provided."
        expression: "!has(this.context) || (has(this.context) && has(this.context.pep) && size(this.context.pep.client_id) > 0)"
    };
    
    // Required. The ID of the action that will trigger this obligation value policy decisioning.
    common.IdNameIdentifier action = 1 [(buf.validate.field).required = true];
    // Required. The attribute value ID that will trigger this obligation value policy decisioning.
    common.IdFqnIdentifier attribute_value = 2 [(buf.validate.field).required = true];
    // Optional. The request context for this obligation value policy decisioning.
    policy.RequestContext context = 3;
}

message GetObligationResponse {
    policy.Obligation obligation = 1;
}

message GetObligationsByFQNsRequest {
    repeated string fqns = 1 [
        (buf.validate.field).repeated = {
            min_items: 1,
            max_items: 250,
            unique: true,
            items: {
                string: {
                    min_len: 1,
                    uri: true
                }
            },
        }
    ];
}

message GetObligationsByFQNsResponse {
    map<string, policy.Obligation> fqn_obligation_map = 1;
}

message CreateObligationRequest {
    // Required
    option (buf.validate.message).oneof = { fields: ["namespace_id", "namespace_fqn"], required: true };
    string namespace_id = 1 [(buf.validate.field).string.uuid = true];
    string namespace_fqn = 2 [
        (buf.validate.field).string = {
            min_len : 1
            uri : true
        }
    ];
    string name = 3 [
        (buf.validate.field).required = true,
        (buf.validate.field).string.max_len = 253,
        (buf.validate.field).cel = {
            id: "obligation_name_format",
            message: "Obligation name must be an alphanumeric string, allowing hyphens and underscores but not as the first or last character. The stored name will be normalized to lower case.",
            expression: "this.matches('^[a-zA-Z0-9](?:[a-zA-Z0-9_-]*[a-zA-Z0-9])?$')"
        }
    ];

    // Optional
    repeated string values = 4 [
        (buf.validate.field).repeated = {
            min_items: 0,
            unique: true,
            items: {
                string: {
                    max_len: 253,
                    pattern: "^[a-zA-Z0-9](?:[a-zA-Z0-9_-]*[a-zA-Z0-9])?$"
                }
            }
        }
    ];

    // Optional
    // Common metadata
    common.MetadataMutable metadata = 100;
}

message CreateObligationResponse {
    policy.Obligation obligation = 1;
}

message UpdateObligationRequest {
    // Required
    string id = 1 [(buf.validate.field).string.uuid = true];

    // Optional
    string name = 2 [
        (buf.validate.field).required = false,
        (buf.validate.field).string.max_len = 253,
        (buf.validate.field).cel = {
            id: "obligation_name_format",
            message: "Obligation name must be an alphanumeric string, allowing hyphens and underscores but not as the first or last character. The stored name will be normalized to lower case.",
            expression: "size(this) > 0 ? this.matches('^[a-zA-Z0-9](?:[a-zA-Z0-9_-]*[a-zA-Z0-9])?$') : true"
        }
    ];
    common.MetadataMutable metadata = 100;
    common.MetadataUpdateEnum metadata_update_behavior = 101;
}

message UpdateObligationResponse {
    policy.Obligation obligation = 1;
}

message DeleteObligationRequest {
    option (buf.validate.message).oneof = { fields: ["id", "fqn"], required: true };
    string id = 1 [(buf.validate.field).string.uuid = true];
    string fqn = 2 [
        (buf.validate.field).string = {
            min_len : 1
            uri : true
        }
    ];
}

message DeleteObligationResponse {
    policy.Obligation obligation = 1;
}

message ListObligationsRequest {
    // Optional
    // Namespace ID or FQN
    option (buf.validate.message).oneof = { fields: ["namespace_id", "namespace_fqn"], required: false };
    string namespace_id = 1 [(buf.validate.field).string.uuid = true];
    string namespace_fqn = 2 [
        (buf.validate.field).string = {
            min_len : 1
            uri : true
        }
    ];

    // Optional
    policy.PageRequest pagination = 10;
}

message ListObligationsResponse {
    repeated policy.Obligation obligations = 1;

    policy.PageResponse pagination = 10;
}

// Values
message GetObligationValueRequest {
    option (buf.validate.message).oneof = { fields: ["id", "fqn"], required: true };
    string id = 1 [(buf.validate.field).string.uuid = true];
    string fqn = 2 [
        (buf.validate.field).string = {
            min_len : 1
            uri : true
        }
    ];
}

message GetObligationValueResponse {
    policy.ObligationValue value = 1;
}

message GetObligationValuesByFQNsRequest {
    repeated string fqns = 1 [
        (buf.validate.field).repeated = {
            min_items: 1,
            max_items: 250,
            unique: true,
            items: {
                string: {
                    min_len: 1,
                    uri: true
                }
            },
        }
    ];
}

message GetObligationValuesByFQNsResponse {
    map<string, policy.ObligationValue> fqn_value_map = 1;
}

message CreateObligationValueRequest {
    // Required
    option (buf.validate.message).oneof = { fields: ["obligation_id", "obligation_fqn"], required: true };
    string obligation_id = 1 [(buf.validate.field).string.uuid = true];
    string obligation_fqn = 2 [
        (buf.validate.field).string = {
            min_len : 1
            uri : true
        }
    ];
    string value = 3 [
        (buf.validate.field).required = true,
        (buf.validate.field).string.max_len = 253,
        (buf.validate.field).cel = {
            id: "obligation_value_format",
            message: "Obligation value must be an alphanumeric string, allowing hyphens and underscores but not as the first or last character. The stored value will be normalized to lower case.",
            expression: "this.matches('^[a-zA-Z0-9](?:[a-zA-Z0-9_-]*[a-zA-Z0-9])?$')"
        }
    ];

    // Optional
    // Combination of action and attribute_value that will trigger this obligation value policy decisioning.
    repeated ValueTriggerRequest triggers = 4;

    // Optional
    // Common metadata
    common.MetadataMutable metadata = 100;
}

message CreateObligationValueResponse {
    policy.ObligationValue value = 1;
}

message UpdateObligationValueRequest {
    // Required
    string id = 1 [(buf.validate.field).string.uuid = true];
    
    // Optional
    string value = 2 [
        (buf.validate.field).required = false,
        (buf.validate.field).string.max_len = 253,
        (buf.validate.field).cel = {
            id: "obligation_value_format",
            message: "Obligation value must be an alphanumeric string, allowing hyphens and underscores but not as the first or last character. The stored value will be normalized to lower case.",
            expression: "size(this) > 0 ? this.matches('^[a-zA-Z0-9](?:[a-zA-Z0-9_-]*[a-zA-Z0-9])?$') : true"
        }
    ];
    
    // Optional
    // Obligation Triggers provided here will replace all existing records in the database.
    repeated ValueTriggerRequest triggers = 3;

    // Optional
    // Common metadata
    common.MetadataMutable metadata = 100;
    common.MetadataUpdateEnum metadata_update_behavior = 101;
}

message UpdateObligationValueResponse {
    policy.ObligationValue value = 1;
}

message DeleteObligationValueRequest {
    option (buf.validate.message).oneof = { fields: ["id", "fqn"], required: true };
    string id = 1 [(buf.validate.field).string.uuid = true];
    string fqn = 2 [
        (buf.validate.field).string = {
            min_len : 1
            uri : true
        }
    ];
}

message DeleteObligationValueResponse {
    policy.ObligationValue value = 1;
}

// Triggers
message AddObligationTriggerRequest {
    option (buf.validate.message).cel = {
        id: "context_client_id_required"
        message: "RequestContext must have a clientID specified when provided."
        expression: "!has(this.context) || (has(this.context) && has(this.context.pep) && size(this.context.pep.client_id) > 0)"
    };
    
    // Required
    common.IdFqnIdentifier obligation_value = 1 [(buf.validate.field).required = true];
    // Required
    common.IdNameIdentifier action = 2 [(buf.validate.field).required = true];
    // Required
    common.IdFqnIdentifier attribute_value = 3 [(buf.validate.field).required = true];

    // Optional
    // The request context for this obligation value policy decisioning.
    policy.RequestContext context = 4;

    // Optional
    // Common metadata
    common.MetadataMutable metadata = 100;
}

message AddObligationTriggerResponse {
    policy.ObligationTrigger trigger = 1;
}

message RemoveObligationTriggerRequest {
    // Required
    string id = 1 [(buf.validate.field).string.uuid = true];
}

message RemoveObligationTriggerResponse {
    policy.ObligationTrigger trigger = 1;
}

// Fulfillers
// message AddObligationFulfillerRequest {
//     // Required
//     string obligation_value_id = 1;
//     google.protobuf.Struct conditionals = 2;
//     // Optional
//     // Common metadata
//     common.MetadataMutable metadata = 100;
// }

// message AddObligationFulfillerResponse {
//     policy.ObligationFulfiller fulfiller = 1;
// }

// message RemoveObligationFulfillerRequest {
//     string id = 1;
// }

// message RemoveObligationFulfillerResponse {
//     policy.ObligationFulfiller fulfiller = 1;
// }

///
/// Obligation Service
///
service Service {

   /*--------------------------------------*
    * Obligation RPCs
    *--------------------------------------*/

    rpc ListObligations(ListObligationsRequest) returns (ListObligationsResponse) {
        option idempotency_level = NO_SIDE_EFFECTS;
    }

    rpc GetObligation(GetObligationRequest) returns (GetObligationResponse) {
        option idempotency_level = NO_SIDE_EFFECTS;
    }

    rpc GetObligationsByFQNs(GetObligationsByFQNsRequest) returns (GetObligationsByFQNsResponse) {
        option idempotency_level = NO_SIDE_EFFECTS;
    }

    rpc CreateObligation(CreateObligationRequest) returns (CreateObligationResponse) {}

    rpc UpdateObligation(UpdateObligationRequest) returns (UpdateObligationResponse) {}
    
    rpc DeleteObligation(DeleteObligationRequest) returns (DeleteObligationResponse) {}

   /*--------------------------------------*
    * Value RPCs
    *--------------------------------------*/

    rpc GetObligationValue(GetObligationValueRequest) returns (GetObligationValueResponse) {
        option idempotency_level = NO_SIDE_EFFECTS;
    }

    rpc GetObligationValuesByFQNs(GetObligationValuesByFQNsRequest) returns (GetObligationValuesByFQNsResponse) {
        option idempotency_level = NO_SIDE_EFFECTS;
    }

    rpc CreateObligationValue(CreateObligationValueRequest) returns (CreateObligationValueResponse) {}

    rpc UpdateObligationValue(UpdateObligationValueRequest) returns (UpdateObligationValueResponse) {}
    
    rpc DeleteObligationValue(DeleteObligationValueRequest) returns (DeleteObligationValueResponse) {}

   /*--------------------------------------*
    * Trigger RPCs
    *--------------------------------------*/
    
    rpc AddObligationTrigger(AddObligationTriggerRequest) returns (AddObligationTriggerResponse) {}

    rpc RemoveObligationTrigger(RemoveObligationTriggerRequest) returns (RemoveObligationTriggerResponse) {}

   /*--------------------------------------*
    * Fulfiller RPCs
    *--------------------------------------*/

    // rpc AddObligationFulfiller(AddObligationFulfillerRequest) returns (AddObligationFulfillerResponse) {}

    // rpc RemoveObligationFulfiller(RemoveObligationFulfillerRequest) returns (RemoveObligationFulfillerResponse) {}   
}