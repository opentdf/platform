syntax = "proto3";

package policy.obligations;

import "common/common.proto";
import "policy/objects.proto";
import "google/protobuf/struct.proto";

///
/// Obligation
///

// Definitions
message GetObligationRequest {
    string id = 1;
}

message GetObligationResponse {
    policy.Obligation obligation = 1;
}

message CreateObligationRequest {
    // Required
    string namespace_id = 1;
    string name = 2;
    // Optional
    // Common metadata
    common.MetadataMutable metadata = 100;
}

message CreateObligationResponse {
    policy.Obligation obligation = 1;
}

message UpdateObligationRequest {
    // Required
    string id = 1;

    // Optional
    common.MetadataMutable metadata = 100;
    common.MetadataUpdateEnum metadata_update_behavior = 101;
}

message UpdateObligationResponse {
    policy.Obligation obligation = 1;
}

message DeleteObligationRequest {
    string id = 1;
}

message DeleteObligationResponse {
    policy.Obligation obligation = 1;
}

message ListObligationsRequest {
    // Optional
    // Namespace ID or name
    string namespace = 1;

    // Optional
    policy.PageRequest pagination = 10;
}

message ListObligationsResponse {
    repeated policy.Obligation obligations = 1;

    policy.PageResponse pagination = 10;
}

// Values
message GetObligationValueRequest {
    string id = 1;
}

message GetObligationValueResponse {
    policy.ObligationValue value = 1;
}

message CreateObligationValueRequest {
    // Required
    string obligation_id = 1;
    string value = 2;
    // Optional
    // Common metadata
    common.MetadataMutable metadata = 100;
}

message CreateObligationValueResponse {
    policy.ObligationValue value = 1;
}

message UpdateObligationValueRequest {
    // Required
    string id = 1;
    
    // Optional
    common.MetadataMutable metadata = 100;
    common.MetadataUpdateEnum metadata_update_behavior = 101;
}

message UpdateObligationValueResponse {
    policy.ObligationValue value = 1;
}

message DeleteObligationValueRequest {
    string id = 1;
}

message DeleteObligationValueResponse {
    policy.ObligationValue value = 1;
}

message ListObligationValuesRequest {
  // Required
  string obligation_id = 1;

  // Optional
  policy.PageRequest pagination = 10;
}

message ListObligationValuesResponse {
  repeated policy.ObligationValue values = 1;

  policy.PageResponse pagination = 10;
}

// Triggers
message AddObligationTriggerRequest {
    // Required
    string obligation_value_id = 1;
    string action_id = 2;
    string attribute_value_id = 3;
    // Optional
    // Common metadata
    common.MetadataMutable metadata = 100;
}

message AddObligationTriggerResponse {
    policy.ObligationTrigger trigger = 1;
}

message RemoveObligationTriggerRequest {
    string id = 1;
}

message RemoveObligationTriggerResponse {
    policy.ObligationTrigger trigger = 1;
}

// Fulfillers
message AddObligationFulfillerRequest {
    // Required
    string obligation_value_id = 1;
    google.protobuf.Struct conditionals = 2;
    // Optional
    // Common metadata
    common.MetadataMutable metadata = 100;
}

message AddObligationFulfillerResponse {
    policy.ObligationFulfiller fulfiller = 1;
}

message RemoveObligationFulfillerRequest {
    string id = 1;
}

message RemoveObligationFulfillerResponse {
    policy.ObligationFulfiller fulfiller = 1;
}

///
/// Obligation Service
///
service ObligationsService {

    /*--------------------------------------*
     * Obligation RPCs
     *--------------------------------------*/

    rpc ListObligations(ListObligationsRequest) returns (ListObligationsResponse) {
        option idempotency_level = NO_SIDE_EFFECTS;
    }

    rpc GetObligation(GetObligationRequest) returns (GetObligationResponse) {
        option idempotency_level = NO_SIDE_EFFECTS;
    }

    //  TODO: create
    rpc UpdateObligation(UpdateObligationRequest) returns (UpdateObligationResponse) {}
    // TODO: delete

    /*--------------------------------------*
     * Value RPCs
     *--------------------------------------*/

    rpc ListObligationValues(ListObligationValuesRequest) returns (ListObligationValuesResponse) {
        option idempotency_level = NO_SIDE_EFFECTS;
    }

    rpc GetObligationValue(GetObligationValueRequest) returns (GetObligationValueResponse) {
        option idempotency_level = NO_SIDE_EFFECTS;
    }

    //  TODO: create
    rpc UpdateObligationValue(UpdateObligationValueRequest) returns (UpdateObligationValueResponse) {}
    // TODO: delete
}